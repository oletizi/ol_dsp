<!-- Generated by SpecStory -->

# MIDI Protocol Analysis Tools for Launch Control XL3 (2025-09-29 15:04:16Z)

<!-- Claude Code Session b425dc03-5240-46c2-ab98-3efc92d5084f (2025-09-29_15-04-16Z) -->

_**User**_

Analyze these staged git changes and output ONLY a single-line conventional commit message (type(scope): description). No explanations.
diff --git a/modules/audio-control/modules/launch-control-xl3/docs/SYSEX-COMPARISON.md b/modules/audio-control/modules/launch-control-xl3/docs/SYSEX-COMPARISON.md
new file mode 100644
index 0000000..969c569
--- /dev/null
+++ b/modules/audio-control/modules/launch-control-xl3/docs/SYSEX-COMPARISON.md
@@ -0,0 +1,86 @@
+# SysEx Protocol Comparison
+
+## Known Working Messages from Web Editor
+
+### 1. Custom Mode Write to Slot 1
+When writing "TestVolume1" to encoder 1 in slot 1:
+```
+0xf0 0x00 0x20 0x29 0x02 0x15 0x05 0x00 0x15 0x00 0x06 0xf7
+```
+
+Breaking down:
+- `0xf0` - SysEx start
+- `0x00 0x20 0x29` - Novation manufacturer ID
+- `0x02 0x15` - Device/model identifiers
+- `0x05` - Command (write?)
+- `0x00` - Unknown
+- `0x15` - Unknown (21 decimal)
+- `0x00` - Slot index (0 = slot 1)
+- `0x06` - Unknown (possibly data length or checksum?)
+- `0xf7` - SysEx end
+
+### 2. Another Write Operation
+```
+0xf0 0x00 0x20 0x29 0x02 0x15 0x05 0x00 0x15 0x03 0x06 0xf7
+```
+
+Similar structure but:
+- `0x03` instead of `0x00` at position 9 (slot 4?)
+
+### 3. Longer Custom Mode Data
+From earlier capture:
+```
+0xf0 0x00 0x20 0x29 0x02 0x15 0x05 0x00 0x10 0x03 0x06 0x20 0x10 0x44 0x65 0x66 0x61 0x75 0x6c 0x74 0x20 0x43 0x75 0x73 0x74 0x6f 0x6d 0x20 0x4d 0x21 0x00 ... 0xf7
+```
+
+This appears to be a complete custom mode with:
+- Similar header: `0xf0 0x00 0x20 0x29 0x02 0x15 0x05 0x00`
+- `0x10` instead of `0x15` at position 8
+- `0x03` - slot index
+- `0x06` - unknown
+- Followed by mode data including ASCII text "Default Custom M"
+
+## Our SysExParser Implementation
+
+Our parser generates a COMPLETELY DIFFERENT format:
+
+### What Our Parser Generates:
+```
+0xf0 0x00 0x20 0x29 0x02 0x15 0x05 0x00 0x45 0x00 ... [1000+ bytes of data] ... 0xf7
+```
+
+- **Length**: 1049 bytes (!!!)
+- **Structure**: Full data dump with all control definitions, labels, and colors
+- **Header**: `0xf0 0x00 0x20 0x29 0x02 0x15 0x05 0x00 0x45`
+- **Content**: Includes definitions for ALL 48 controls, even if not used
+
+### Key Differences:
+
+| Position | Web Editor | Our Parser | Meaning |
+|----------|------------|------------|---------|
+| 0-7      | Same       | Same       | Standard header |
+| 8        | 0x15       | 0x45       | Command type |
+| 9        | Slot       | Slot       | Slot number |
+| 10       | 0x06       | Data...    | Web: end marker, Ours: start of data |
+| 11       | 0xf7       | Data...    | Web: SysEx end, Ours: more data |
+
+## The Core Problem
+
+**We're using the WRONG PROTOCOL!**
+
+1. **Web Editor Protocol**: Sends simple 12-byte "commands" that likely trigger the device to use preset configurations
+2. **Our Protocol**: Tries to send a complete custom mode data dump (1000+ bytes)
+
+The web editor messages appear to be:
+- **Commands to activate/select modes** rather than data transfers
+- **Reference existing configurations** by slot number
+- **Do not contain actual control mappings** in the message itself
+
+## Hypothesis
+
+The short messages from the web editor (e.g., `0xf0...0x15 0x00 0x06 0xf7`) are likely:
+1. **Mode activation commands** - "Switch to custom mode in slot X"
+2. **Configuration references** - "Use preset configuration Y"
+3. **Not data writes at all** - The actual data may be pre-configured or sent differently
+
+This explains why our 1000+ byte messages don't work - we're trying to use a data transfer protocol when the device expects simple command messages.
\ No newline at end of file
diff --git a/modules/audio-control/modules/launch-control-xl3/utils/test-sysex-format.ts b/modules/audio-control/modules/launch-control-xl3/utils/test-sysex-format.ts
new file mode 100644
index 0000000..1b53d9b
--- /dev/null
+++ b/modules/audio-control/modules/launch-control-xl3/utils/test-sysex-format.ts
@@ -0,0 +1,87 @@
+#!/usr/bin/env tsx
+/**
+ * Test to compare our SysEx format with the web editor's format
+ */
+
+import { SysExParser } from '../src/core/SysExParser.js';
+
+console.log('SysEx Format Comparison Test');
+console.log('============================\n');
+
+// Known working messages from web editor
+const webEditorMessages = {
+  slot1Write: [0xf0, 0x00, 0x20, 0x29, 0x02, 0x15, 0x05, 0x00, 0x15, 0x00, 0x06, 0xf7],
+  slot4Write: [0xf0, 0x00, 0x20, 0x29, 0x02, 0x15, 0x05, 0x00, 0x15, 0x03, 0x06, 0xf7],
+};
+
+console.log('Web Editor Format (slot 1):');
+console.log(webEditorMessages.slot1Write.map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
+console.log('\nWeb Editor Format (slot 4):');
+console.log(webEditorMessages.slot4Write.map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
+
+// Create a minimal custom mode
+const testMode = {
+  name: 'Test',
+  controls: [
+    {
+      controlId: 0x0d,
+      name: 'TestVolume1',
+      cc: 13,
+      channel: 0
+    }
+  ],
+  colors: [
+    {
+      controlId: 0x0d,
+      color: 0x0F  // Red
+    }
+  ]
+};
+
+console.log('\n\nOur SysExParser Output:');
+console.log('=======================');
+
+try {
+  // Generate message for slot 0
+  const ourMessage = SysExParser.buildCustomModeWriteRequest(0, testMode);
+  console.log('\nSlot 0 Write:');
+  console.log(ourMessage.map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
+  console.log(`Length: ${ourMessage.length} bytes`);
+
+  // Show just the header for comparison
+  console.log('\nOur header (first 12 bytes):');
+  console.log(ourMessage.slice(0, 12).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
+
+  console.log('\nWeb editor header:');
+  console.log(webEditorMessages.slot1Write.map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
+
+  console.log('\n\nDifferences Found:');
+  console.log('==================');
+  console.log('Position | Web Editor | Our Parser');
+  console.log('---------|------------|------------');
+  for (let i = 0; i < Math.min(12, ourMessage.length); i++) {
+    const webByte = webEditorMessages.slot1Write[i];
+    const ourByte = ourMessage[i];
+    if (webByte !== ourByte) {
+      console.log(`${i.toString().padStart(8)} | 0x${webByte?.toString(16).padStart(2, '0') ?? '??'}       | 0x${ourByte.toString(16).padStart(2, '0')}       ${i === 8 ? '← Key difference!' : ''}`);
+    }
+  }
+
+  console.log('\n\nAnalysis:');
+  console.log('=========');
+  console.log('1. Web editor uses simpler format with just 12 bytes total');
+  console.log('2. Our parser generates a much longer message with full control data');
+  console.log('3. Key byte at position 8:');
+  console.log('   - Web editor: 0x15 (unknown meaning)');
+  console.log('   - Our parser: 0x45 (assumed write operation)');
+  console.log('4. Web editor appears to use a simplified protocol for writes');
+
+} catch (error) {
+  console.error('Error:', error);
+}
+
+console.log('\n\nConclusion:');
+console.log('===========');
+console.log('The web editor uses a much simpler SysEx format than what we generate.');
+console.log('It appears to be a "command" message rather than a full data dump.');
+console.log('The actual custom mode data might be sent separately or in a different way.');
\ No newline at end of file
diff --git a/modules/audio-control/modules/launch-control-xl3/utils/test-write-only.ts b/modules/audio-control/modules/launch-control-xl3/utils/test-write-only.ts
new file mode 100644
index 0000000..197c081
--- /dev/null
+++ b/modules/audio-control/modules/launch-control-xl3/utils/test-write-only.ts
@@ -0,0 +1,72 @@
+#!/usr/bin/env tsx
+/**
+ * Minimal test to reproduce CC 120 flooding issue
+ */
+
+import { LaunchControlXL3 } from '../src/index.js';
+import { EasyMidiBackend } from '../src/core/backends/EasyMidiBackend.js';
+
+async function testWrite() {
+  console.log('Minimal Write Test - Monitoring CC 120 Issue');
+  console.log('============================================\n');
+  console.log('This test will write a simple custom mode and observe device response.\n');
+  console.log('Run midi-monitor.ts in another terminal to capture traffic.\n');
+
+  let device: LaunchControlXL3 | null = null;
+
+  try {
+    // Initialize backend
+    const backend = new EasyMidiBackend();
+    await backend.initialize();
+
+    // Create device with initialized backend
+    device = new LaunchControlXL3({
+      midiBackend: backend,
+      enableLedControl: false,  // Disable LED control to isolate issue
+      enableCustomModes: true
+    });
+
+    console.log('→ Connecting to device...');
+    await device.connect();
+    console.log('✓ Connected\n');
+
+    // Create a minimal custom mode
+    const testMode = {
+      name: 'TestCC120',
+      controls: [
+        {
+          controlId: 0x0d,  // First encoder
+          name: 'Volume1',
+          cc: 13,
+          channel: 0
+        }
+      ]
+    };
+
+    console.log('→ Writing custom mode to slot 0...');
+    console.log('  Mode:', JSON.stringify(testMode, null, 2));
+
+    await device.writeCustomMode(0, testMode);
+
+    console.log('✓ Write completed\n');
+    console.log('⚠️  Check MIDI monitor for CC 120 messages from device\n');
+
+    // Wait a bit to observe any delayed responses
+    console.log('→ Waiting 5 seconds to observe device response...');
+    await new Promise(resolve => setTimeout(resolve, 5000));
+
+    console.log('\n✓ Test completed');
+
+  } catch (error) {
+    console.error('\n✗ Test failed:', error instanceof Error ? error.message : String(error));
+  } finally {
+    if (device) {
+      console.log('\n→ Disconnecting (without cleanup to avoid extra messages)...');
+      await device.disconnect();
+      console.log('✓ Disconnected');
+    }
+  }
+}
+
+// Run the test
+testWrite().catch(console.error);
\ No newline at end of file


---

_**Agent (claude-opus-4-1-20250805)**_

feat(launch-control-xl3): add sysex protocol analysis tools and documentation

