<!-- Generated by SpecStory -->

# MIDI Device Import System with AI Semantic Matching (2025-10-03 19:49:32Z)

<!-- Claude Code Session ab9a9d10-d7fe-426d-abf1-59390791ad0e (2025-10-03_19-49-32Z) -->

_**User**_

Analyze these staged git changes and output ONLY a single-line conventional commit message (type(scope): description). No explanations.
diff --git a/modules/audio-control/modules/launch-control-xl3/utils/backup-slot.ts b/modules/audio-control/modules/launch-control-xl3/utils/backup-slot.ts
new file mode 100644
index 0000000..87e2079
--- /dev/null
+++ b/modules/audio-control/modules/launch-control-xl3/utils/backup-slot.ts
@@ -0,0 +1,112 @@
+#!/usr/bin/env npx tsx
+/**
+ * Backup Custom Mode from Specified Physical Slot
+ *
+ * Reads a custom mode from the specified physical slot (1-15) and saves it to JSON.
+ * Used by import-from-device.cjs to fetch device configurations.
+ *
+ * Usage: tsx backup-slot.ts <slot> <output.json>
+ */
+
+import { writeFileSync } from 'fs';
+import { LaunchControlXL3 } from '../src';
+import { JuceMidiBackend } from '../src/backends/JuceMidiBackend';
+
+async function backupSlot(physicalSlot: number, outputPath: string) {
+  console.log(`üìñ Reading mode from device physical slot ${physicalSlot}...`);
+
+  // Convert physical slot (1-15) to API slot (0-14)
+  const apiSlot = physicalSlot - 1;
+
+  // Create device with JUCE backend
+  const backend = new JuceMidiBackend({ host: 'localhost', port: 7777 });
+  const device = new LaunchControlXL3({ midiBackend: backend });
+
+  try {
+    await device.connect();
+
+    const currentMode = await device.loadCustomMode(apiSlot);
+
+    if (!currentMode) {
+      throw new Error(`No mode found in physical slot ${physicalSlot}`);
+    }
+
+    console.log(`‚úì Successfully read mode: "${currentMode.name}"`);
+    console.log(`  Controls: ${Object.keys(currentMode.controls).length}`);
+
+    // Extract labels from control.name properties
+    const labels: Record<string, string> = {};
+    for (const [controlId, control] of Object.entries(currentMode.controls)) {
+      if (control.name) {
+        labels[controlId] = control.name;
+      }
+    }
+
+    // Store in JSON format
+    const jsonData = {
+      metadata: {
+        physicalSlot,
+        apiSlot,
+        timestamp: new Date().toISOString(),
+        deviceInfo: device.isConnected() ? await device.verifyDevice() : null
+      },
+      mode: {
+        name: currentMode.name,
+        controls: Object.fromEntries(
+          Object.entries(currentMode.controls).map(([id, control]) => [
+            id,
+            {
+              controlType: control.controlType,
+              midiChannel: control.midiChannel,
+              ccNumber: control.ccNumber,
+              behavior: control.behavior,
+              name: control.name, // Include the label
+              ...control
+            }
+          ])
+        ),
+        labels,
+        metadata: currentMode.metadata
+      }
+    };
+
+    writeFileSync(outputPath, JSON.stringify(jsonData, null, 2));
+    console.log(`üíæ Mode backup saved: ${outputPath}`);
+
+  } catch (error) {
+    console.error('‚ùå Backup failed:', error);
+    throw error;
+  } finally {
+    await device.disconnect();
+    await backend.close();
+  }
+}
+
+// Parse command line arguments
+const args = process.argv.slice(2);
+
+if (args.length < 2) {
+  console.error('Usage: tsx backup-slot.ts <slot> <output.json>');
+  console.error('');
+  console.error('Arguments:');
+  console.error('  slot        - Physical slot number (1-15)');
+  console.error('  output.json - Output file path');
+  console.error('');
+  console.error('Example:');
+  console.error('  tsx backup-slot.ts 1 /tmp/slot1.json');
+  process.exit(1);
+}
+
+const physicalSlot = parseInt(args[0]);
+const outputPath = args[1];
+
+if (isNaN(physicalSlot) || physicalSlot < 1 || physicalSlot > 15) {
+  console.error('Error: Slot must be a number between 1 and 15 (physical slot number)');
+  process.exit(1);
+}
+
+// Run the backup
+backupSlot(physicalSlot, outputPath).catch(error => {
+  console.error('Fatal error:', error);
+  process.exit(1);
+});
diff --git a/modules/audio-control/modules/live-max-cc-router/scripts/import-from-device.cjs b/modules/audio-control/modules/live-max-cc-router/scripts/import-from-device.cjs
index cab2ffe..6228735 100644
--- a/modules/audio-control/modules/live-max-cc-router/scripts/import-from-device.cjs
+++ b/modules/audio-control/modules/live-max-cc-router/scripts/import-from-device.cjs
@@ -8,13 +8,17 @@ const yaml = require('yaml');
 /**
  * Import canonical mapping from Launch Control XL3 custom mode
  *
- * Reads control names and CC mappings from an attached device,
- * then uses AI to match them to plugin parameters.
+ * Uses the launch-control-xl3 backup utility to fetch a mode from device,
+ * then uses AI to match controls to plugin parameters.
  *
  * Usage: node import-from-device.cjs <slot> <descriptor.json> <output.yaml>
  *
+ * Requirements:
+ *   - JUCE MIDI server running (cd ../launch-control-xl3 && pnpm env:juce-server)
+ *   - Launch Control XL 3 connected via USB
+ *
  * Arguments:
- *   slot            - Custom mode slot number (0-15)
+ *   slot            - Custom mode slot number (1-15, physical slot number)
  *   descriptor.json - Plugin descriptor file path
  *   output.yaml     - Output canonical mapping file path
  */
@@ -24,84 +28,98 @@ async function importFromDevice(slot, descriptorPath, outputPath) {
   console.log('‚ïë                    IMPORT MAPPING FROM DEVICE                                    ‚ïë');
   console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
 
-  console.log(`üì° Connecting to Launch Control XL3...\n`);
-
-  // Import the launch-control-xl3 library
   const lcxl3Path = path.join(__dirname, '../../launch-control-xl3');
+  const backupScript = path.join(lcxl3Path, 'utils/backup-slot.ts');
 
-  let LaunchControlXL3;
+  // Check if JUCE server is running
+  console.log('üîç Checking JUCE MIDI server...\n');
   try {
-    // Try to import from the module
-    const moduleExports = await import(`${lcxl3Path}/dist/index.js`);
-    LaunchControlXL3 = moduleExports.LaunchControlXL3;
+    execSync('curl -s http://localhost:7777/health', { stdio: 'pipe' });
+    console.log('‚úì JUCE MIDI server is running\n');
   } catch (error) {
-    console.error('Error loading launch-control-xl3 library:', error.message);
-    console.error('\nMake sure the launch-control-xl3 module is built:');
-    console.error('  cd ../launch-control-xl3 && npm run build');
+    console.error('‚ùå JUCE MIDI server not running!');
+    console.error('\nPlease start the server:');
+    console.error('  cd ../launch-control-xl3 && pnpm env:juce-server');
+    console.error('\nOr check environment:');
+    console.error('  cd ../launch-control-xl3 && pnpm env:check\n');
     process.exit(1);
   }
 
-  // Connect to device
-  const device = new LaunchControlXL3({
-    enableCustomModes: true
-  });
+  // Fetch mode from device using backup utility
+  console.log(`üì° Fetching mode from device slot ${slot}...\n`);
+
+  const tempBackup = `/tmp/lcxl3-import-${Date.now()}.json`;
 
   try {
-    await device.connect();
-    console.log('‚úì Connected to device\n');
+    // Run backup utility
+    execSync(`cd ${lcxl3Path} && tsx ${backupScript} ${slot} ${tempBackup}`, {
+      stdio: 'inherit'
+    });
+
+    if (!fs.existsSync(tempBackup)) {
+      throw new Error('Backup file was not created');
+    }
+
+    console.log(`\n‚úì Mode fetched successfully\n`);
 
-    console.log(`üì• Loading custom mode from slot ${slot}...\n`);
-    const mode = await device.loadCustomMode(slot);
+  } catch (error) {
+    console.error('\n‚ùå Failed to fetch mode from device');
+    console.error('Error:', error.message);
+    console.error('\nMake sure:');
+    console.error('  1. Launch Control XL 3 is connected via USB');
+    console.error('  2. Device is powered on');
+    console.error('  3. JUCE MIDI server is running\n');
+    process.exit(1);
+  }
 
-    console.log(`Mode: ${mode.name || 'Unnamed'}`);
-    console.log(`Controls: ${Object.keys(mode.controls || {}).length}\n`);
+  // Read the fetched mode
+  const backup = JSON.parse(fs.readFileSync(tempBackup, 'utf8'));
+  const mode = backup.mode;
 
-    // Extract control information
-    const controls = extractControls(mode);
-    console.log(`Extracted ${controls.length} controls with labels\n`);
+  console.log(`Mode: ${mode.name || 'Unnamed'}`);
+  console.log(`Controls: ${Object.keys(mode.controls || {}).length}\n`);
 
-    // Load plugin descriptor
-    if (!fs.existsSync(descriptorPath)) {
-      throw new Error(`Plugin descriptor not found: ${descriptorPath}`);
-    }
+  // Extract control information
+  const controls = extractControls(mode);
+  console.log(`Extracted ${controls.length} controls with labels\n`);
 
-    const descriptor = JSON.parse(fs.readFileSync(descriptorPath, 'utf8'));
-    console.log(`Plugin: ${descriptor.pluginName || 'Unknown'}\n`);
+  // Load plugin descriptor
+  if (!fs.existsSync(descriptorPath)) {
+    throw new Error(`Plugin descriptor not found: ${descriptorPath}`);
+  }
 
-    // Use AI to match controls to parameters
-    console.log('ü§ñ Using Claude AI to match controls to parameters...\n');
-    const mappings = await matchControlsToParameters(controls, descriptor);
+  const descriptor = JSON.parse(fs.readFileSync(descriptorPath, 'utf8'));
+  console.log(`Plugin: ${descriptor.pluginName || 'Unknown'}\n`);
 
-    console.log(`‚úì Matched ${mappings.length} controls to parameters\n`);
+  // Use AI to match controls to parameters
+  console.log('ü§ñ Using Claude AI to match controls to parameters...\n');
+  const mappings = await matchControlsToParameters(controls, descriptor);
 
-    // Generate canonical mapping YAML
-    const canonicalMapping = generateCanonicalMapping(mode, descriptor, mappings);
+  console.log(`‚úì Matched ${mappings.length} controls to parameters\n`);
 
-    // Write output
-    fs.writeFileSync(outputPath, yaml.stringify(canonicalMapping, {
-      lineWidth: 0,
-      defaultStringType: 'QUOTE_DOUBLE',
-    }), 'utf8');
+  // Generate canonical mapping YAML
+  const canonicalMapping = generateCanonicalMapping(mode, descriptor, mappings);
 
-    console.log(`‚úÖ Canonical mapping saved to: ${outputPath}\n`);
+  // Write output
+  fs.writeFileSync(outputPath, yaml.stringify(canonicalMapping, {
+    lineWidth: 0,
+    defaultStringType: 'QUOTE_DOUBLE',
+  }), 'utf8');
 
-    await device.disconnect();
+  console.log(`‚úÖ Canonical mapping saved to: ${outputPath}\n`);
 
-  } catch (error) {
-    console.error('\n‚ùå Error:', error.message);
-    await device.disconnect();
-    process.exit(1);
-  }
+  // Clean up temp file
+  fs.unlinkSync(tempBackup);
 }
 
 function extractControls(mode) {
   const controls = [];
   const modeControls = mode.controls || {};
-  const labels = mode.labels || {};
 
   // Extract controls with their labels
   for (const [controlId, control] of Object.entries(modeControls)) {
-    const label = labels[controlId] || controlId;
+    // Use control.name for label (comes from loadCustomMode)
+    const label = control.name || controlId;
 
     controls.push({
       id: controlId,
@@ -261,12 +279,15 @@ if (require.main === module) {
 
   if (args.length < 3) {
     console.error('Usage: node import-from-device.cjs <slot> <descriptor.json> <output.yaml>');
+    console.error('\nRequirements:');
+    console.error('  - JUCE MIDI server running (cd ../launch-control-xl3 && pnpm env:juce-server)');
+    console.error('  - Launch Control XL 3 connected via USB');
     console.error('\nArguments:');
-    console.error('  slot            - Custom mode slot number (0-15)');
+    console.error('  slot            - Custom mode slot number (1-15, physical slot)');
     console.error('  descriptor.json - Plugin descriptor file path');
     console.error('  output.yaml     - Output canonical mapping file path');
     console.error('\nExample:');
-    console.error('  node import-from-device.cjs 0 \\');
+    console.error('  node import-from-device.cjs 1 \\');
     console.error('    ../canonical-midi-maps/plugin-descriptors/analogobsession-channev.json \\');
     console.error('    ../canonical-midi-maps/maps/novation-launch-control-xl-3/channel-strips/my-mapping.yaml');
     process.exit(1);
@@ -275,14 +296,14 @@ if (require.main === module) {
   const [slotStr, descriptorPath, outputPath] = args;
   const slot = parseInt(slotStr);
 
-  if (isNaN(slot) || slot < 0 || slot > 15) {
-    console.error('Error: Slot must be a number between 0 and 15');
+  if (isNaN(slot) || slot < 1 || slot > 15) {
+    console.error('Error: Slot must be a number between 1 and 15 (physical slot number)');
     process.exit(1);
   }
 
   importFromDevice(slot, descriptorPath, outputPath)
     .catch(err => {
-      console.error('Fatal error:', err);
+      console.error('\nFatal error:', err.message);
       process.exit(1);
     });
 }


---

_**Agent (claude-sonnet-4-5-20250929)**_

feat(launch-control-xl3): add backup-slot utility and refactor import-from-device to use it

