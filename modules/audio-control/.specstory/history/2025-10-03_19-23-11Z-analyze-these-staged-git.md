<!-- Generated by SpecStory -->

# AI-Powered MIDI Mapping Verification and Fix System (2025-10-03 19:23:11Z)

<!-- Claude Code Session 46daa6bd-a24f-4bf5-9244-bec4f79c48fc (2025-10-03_19-23-11Z) -->

_**User**_

Analyze these staged git changes and output ONLY a single-line conventional commit message (type(scope): description). No explanations.
diff --git a/modules/audio-control/modules/canonical-midi-maps/maps/novation-launch-control-xl-3/channel-strips/analog-obsession-channev.yaml b/modules/audio-control/modules/canonical-midi-maps/maps/novation-launch-control-xl-3/channel-strips/analog-obsession-channev.yaml
index c388f9b..22a7f35 100644
--- a/modules/audio-control/modules/canonical-midi-maps/maps/novation-launch-control-xl-3/channel-strips/analog-obsession-channev.yaml
+++ b/modules/audio-control/modules/canonical-midi-maps/maps/novation-launch-control-xl-3/channel-strips/analog-obsession-channev.yaml
@@ -346,7 +346,7 @@
         "cc": 37
         "channel": "global"
         "mode": "toggle"
-        "plugin_parameter": "1"
+        "plugin_parameter": "32"
       - "id": "button_2"
         "name": "EQ Low Peak"
         "cc": 38
@@ -370,7 +370,7 @@
         "cc": 45
         "channel": "global"
         "mode": "toggle"
-        "plugin_parameter": "1"
+        "plugin_parameter": "34"
       - "id": "button_6"
         "name": "EQ Enable"
         "cc": 46
diff --git a/modules/audio-control/modules/live-max-cc-router/package.json b/modules/audio-control/modules/live-max-cc-router/package.json
index 14b1bf4..ea1022b 100644
--- a/modules/audio-control/modules/live-max-cc-router/package.json
+++ b/modules/audio-control/modules/live-max-cc-router/package.json
@@ -31,7 +31,8 @@
     "typecheck": "tsc --noEmit",
     "test": "vitest run",
     "verify-mapping": "node scripts/ai-verify-mapping.cjs",
-    "verify-mapping:channev": "node scripts/ai-verify-mapping.cjs ../canonical-midi-maps/maps/novation-launch-control-xl-3/channel-strips/analog-obsession-channev.yaml ../canonical-midi-maps/plugin-descriptors/analogobsession-channev.json"
+    "verify-mapping:channev": "node scripts/ai-verify-mapping.cjs ../canonical-midi-maps/maps/novation-launch-control-xl-3/channel-strips/analog-obsession-channev.yaml ../canonical-midi-maps/plugin-descriptors/analogobsession-channev.json",
+    "fix-mapping:channev": "node scripts/ai-verify-mapping.cjs ../canonical-midi-maps/maps/novation-launch-control-xl-3/channel-strips/analog-obsession-channev.yaml ../canonical-midi-maps/plugin-descriptors/analogobsession-channev.json --fix"
   },
   "keywords": [
     "max-for-live",
diff --git a/modules/audio-control/modules/live-max-cc-router/scripts/ai-verify-mapping.cjs b/modules/audio-control/modules/live-max-cc-router/scripts/ai-verify-mapping.cjs
index 875d893..518e3f1 100644
--- a/modules/audio-control/modules/live-max-cc-router/scripts/ai-verify-mapping.cjs
+++ b/modules/audio-control/modules/live-max-cc-router/scripts/ai-verify-mapping.cjs
@@ -7,7 +7,10 @@ const yaml = require('yaml');
 /**
  * Verify MIDI mappings using Claude Code CLI for semantic analysis
  *
- * Usage: node ai-verify-mapping.cjs <mapping.yaml> <descriptor.json>
+ * Usage: node ai-verify-mapping.cjs <mapping.yaml> <descriptor.json> [--fix]
+ *
+ * Options:
+ *   --fix    Automatically update the mapping YAML file with corrected indices
  */
 
 function generatePrompt(mappingPath, descriptorPath) {
@@ -17,15 +20,17 @@ function generatePrompt(mappingPath, descriptorPath) {
   const mapping = yaml.parse(mappingYaml);
   const descriptor = JSON.parse(descriptorJson);
 
-  // Extract control names
+  // Extract control names and keep reference to controls for fixing
   const controls = mapping.controls || [];
   const controlNames = [];
+  const controlRefs = []; // Keep references for updating
 
   function collectControl(ctrl) {
     if (!ctrl.plugin_parameter) return;
     const paramIndex = parseInt(ctrl.plugin_parameter);
     if (isNaN(paramIndex)) return; // Skip special params
     controlNames.push(ctrl.name);
+    controlRefs.push(ctrl); // Store reference for later updates
   }
 
   controls.forEach(control => {
@@ -76,6 +81,7 @@ For example:
   return {
     prompt,
     controlNames,
+    controlRefs,
     paramsByIndex: descriptor.parameters.reduce((acc, p) => {
       acc[p.index] = p;
       return acc;
@@ -85,6 +91,67 @@ For example:
   };
 }
 
+function fixMappings(mappingPath, mapping, controlRefs, results) {
+  let fixed = 0;
+  const changes = [];
+
+  // Update control references with AI results
+  results.forEach((result, i) => {
+    if (controlRefs[i]) {
+      const oldValue = controlRefs[i].plugin_parameter;
+      const newValue = result.paramIndex.toString();
+
+      if (oldValue !== newValue) {
+        controlRefs[i].plugin_parameter = newValue;
+        changes.push({
+          control: result.control,
+          oldIndex: oldValue,
+          newIndex: newValue,
+          paramName: result.paramName
+        });
+        fixed++;
+      }
+    }
+  });
+
+  if (fixed > 0) {
+    // Write updated mapping (using the modified mapping object)
+    const updatedYaml = yaml.stringify(mapping, {
+      lineWidth: 0,
+      defaultStringType: 'QUOTE_DOUBLE',
+    });
+
+    fs.writeFileSync(mappingPath, updatedYaml, 'utf8');
+
+    console.log('\n' + '='.repeat(85));
+    console.log('ðŸ”§ FIXED MAPPINGS\n');
+    console.log('â”€'.repeat(85));
+    console.log(
+      pad('Control', 30) +
+      pad('Old', 8) +
+      pad('New', 8) +
+      pad('Parameter', 35)
+    );
+    console.log('â”€'.repeat(85));
+
+    changes.forEach(change => {
+      console.log(
+        pad(change.control, 30) +
+        pad(change.oldIndex, 8) +
+        pad(change.newIndex, 8) +
+        pad(change.paramName, 35)
+      );
+    });
+
+    console.log('â”€'.repeat(85));
+    console.log(`\nâœ… Fixed ${fixed} mappings in ${mappingPath}\n`);
+  } else {
+    console.log('\nâœ… No fixes needed - all mappings are already correct!\n');
+  }
+
+  return fixed;
+}
+
 function parseClaudeResponse(response, controlNames, paramsByIndex) {
   const lines = response.trim().split('\n');
   const results = [];
@@ -151,16 +218,23 @@ function pad(str, width) {
 if (require.main === module) {
   const args = process.argv.slice(2);
 
-  if (args.length < 2) {
-    console.error('Usage: node ai-verify-mapping.cjs <mapping.yaml> <descriptor.json>');
+  // Parse flags
+  const fixMode = args.includes('--fix');
+  const fileArgs = args.filter(arg => !arg.startsWith('--'));
+
+  if (fileArgs.length < 2) {
+    console.error('Usage: node ai-verify-mapping.cjs <mapping.yaml> <descriptor.json> [--fix]');
+    console.error('\nOptions:');
+    console.error('  --fix    Automatically update the mapping YAML file with corrected indices');
     console.error('\nExample:');
     console.error('  node ai-verify-mapping.cjs \\');
     console.error('    maps/novation-launch-control-xl-3/channel-strips/analog-obsession-channev.yaml \\');
-    console.error('    plugin-descriptors/analogobsession-channev.json');
+    console.error('    plugin-descriptors/analogobsession-channev.json \\');
+    console.error('    --fix');
     process.exit(1);
   }
 
-  const [mappingPath, descriptorPath] = args;
+  const [mappingPath, descriptorPath] = fileArgs;
 
   if (!fs.existsSync(mappingPath)) {
     console.error(`Error: Mapping file not found: ${mappingPath}`);
@@ -173,7 +247,7 @@ if (require.main === module) {
   }
 
   console.log('ðŸ¤– Generating prompt for Claude Code...\n');
-  const { prompt, controlNames, paramsByIndex, mapping } = generatePrompt(mappingPath, descriptorPath);
+  const { prompt, controlNames, controlRefs, paramsByIndex, mapping } = generatePrompt(mappingPath, descriptorPath);
 
   // Write prompt to temp file
   const promptFile = '/tmp/claude-mapping-prompt.txt';
@@ -226,6 +300,11 @@ if (require.main === module) {
     // Display results
     displayResults(results, mapping);
 
+    // Fix mappings if requested
+    if (fixMode) {
+      fixMappings(mappingPath, mapping, controlRefs, results);
+    }
+
   } catch (error) {
     console.error('Error calling Claude Code CLI:', error.message);
     console.error('\nMake sure Claude Code CLI is installed and available as "claude" command.');
@@ -234,4 +313,4 @@ if (require.main === module) {
   }
 }
 
-module.exports = { generatePrompt, parseClaudeResponse };
+module.exports = { generatePrompt, parseClaudeResponse, fixMappings };


---

_**Agent (claude-sonnet-4-5-20250929)**_

fix(mappings): correct CHANNEV button parameter indices and add auto-fix script

