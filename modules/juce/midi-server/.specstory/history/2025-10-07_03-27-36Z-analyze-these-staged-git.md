<!-- Generated by SpecStory -->

# 2025-10-07 03:27:36Z

<!-- Claude Code Session a84a6512-37be-4fd0-b834-72673c0b9000 (2025-10-07_03-27-36Z) -->

_**User**_

Analyze these staged git changes and output ONLY a single-line conventional commit message (type(scope): description). No explanations.
diff --git a/modules/juce/midi-server/NetworkMidiServer.cpp b/modules/juce/midi-server/NetworkMidiServer.cpp
index 7621f4d..177b2c2 100644
--- a/modules/juce/midi-server/NetworkMidiServer.cpp
+++ b/modules/juce/midi-server/NetworkMidiServer.cpp
@@ -476,7 +476,7 @@ private:
                 auto inputs = juce::MidiInput::getAvailableDevices();
                 for (const auto& deviceInfo : inputs) {
                     if (inputDeviceMap.count(deviceInfo.identifier) > 0 &&
-                        inputDeviceMap[deviceInfo.identifier] == device.id) {
+                        inputDeviceMap[deviceInfo.identifier] == device.id()) {
                         // Re-open and start the input
                         auto input = juce::MidiInput::openDevice(
                             deviceInfo.identifier,
@@ -630,11 +630,11 @@ private:
                 json.key("devices").startArray();
                 for (const auto& device : devices) {
                     json.startObject()
-                        .key("id").value((int)device.id)
+                        .key("id").value((int)device.id())
                         .key("name").value(device.name.toStdString())
                         .key("type").value(device.type.toStdString())
-                        .key("is_local").value(device.isLocal)
-                        .key("owner_node").value(device.ownerNode.toString().toStdString())
+                        .key("is_local").value(device.isLocal())
+                        .key("owner_node").value(device.ownerNode().toString().toStdString())
                         .endObject();
                 }
                 json.endArray();
@@ -781,7 +781,7 @@ private:
                     json.key("devices").startArray();
                     for (const auto& device : devices) {
                         json.startObject()
-                            .key("id").value((int)device.id)
+                            .key("id").value((int)device.id())
                             .key("name").value(device.name.toStdString())
                             .key("type").value(device.type.toStdString())
                             .endObject();
diff --git a/modules/juce/midi-server/network/routing/DeviceRegistry.cpp b/modules/juce/midi-server/network/routing/DeviceRegistry.cpp
index d17b546..a071e9e 100644
--- a/modules/juce/midi-server/network/routing/DeviceRegistry.cpp
+++ b/modules/juce/midi-server/network/routing/DeviceRegistry.cpp
@@ -240,14 +240,16 @@ uint16_t DeviceRegistry::getNextAvailableId() const
 {
     std::lock_guard<std::mutex> lock(deviceMutex);
 
-    // Find first available ID
+    // Find first available ID for local devices (null UUID)
     uint16_t candidateId = nextDeviceId;
+    DeviceKey localKey(juce::Uuid::null(), candidateId);
 
-    while (devices.find(candidateId) != devices.end()) {
+    while (devices.find(localKey) != devices.end()) {
         candidateId++;
         if (candidateId == 0) {
             throw std::runtime_error("Device ID space exhausted");
         }
+        localKey = DeviceKey(juce::Uuid::null(), candidateId);
     }
 
     return candidateId;
@@ -256,7 +258,9 @@ uint16_t DeviceRegistry::getNextAvailableId() const
 bool DeviceRegistry::isDeviceIdAvailable(uint16_t deviceId) const
 {
     std::lock_guard<std::mutex> lock(deviceMutex);
-    return devices.find(deviceId) == devices.end();
+    // Check if a local device with this ID exists
+    DeviceKey localKey(juce::Uuid::null(), deviceId);
+    return devices.find(localKey) == devices.end();
 }
 
 //==============================================================================
diff --git a/modules/juce/midi-server/network/routing/VirtualMidiPort.cpp b/modules/juce/midi-server/network/routing/VirtualMidiPort.cpp
index cc4a168..a2df579 100644
--- a/modules/juce/midi-server/network/routing/VirtualMidiPort.cpp
+++ b/modules/juce/midi-server/network/routing/VirtualMidiPort.cpp
@@ -143,7 +143,7 @@ std::unique_ptr<VirtualMidiPort>
 VirtualMidiPortFactory::createForRemoteDevice(const MidiDevice& remoteDevice,
                                               NetworkTransport* transport)
 {
-    if (remoteDevice.isLocal) {
+    if (remoteDevice.isLocal()) {
         throw std::invalid_argument("Cannot create virtual port for local device");
     }
 
@@ -151,8 +151,8 @@ VirtualMidiPortFactory::createForRemoteDevice(const MidiDevice& remoteDevice,
 
     return std::make_unique<VirtualMidiPort>(
         remoteDevice.name,
-        remoteDevice.ownerNode,
-        remoteDevice.id,
+        remoteDevice.ownerNode(),
+        remoteDevice.id(),
         transport,
         isInput);
 }
diff --git a/modules/juce/midi-server/tests/unit/DeviceRegistryTest.cpp b/modules/juce/midi-server/tests/unit/DeviceRegistryTest.cpp
index 59b90e6..d0ba85f 100644
--- a/modules/juce/midi-server/tests/unit/DeviceRegistryTest.cpp
+++ b/modules/juce/midi-server/tests/unit/DeviceRegistryTest.cpp
@@ -34,13 +34,13 @@ protected:
 TEST_F(DeviceRegistryTest, AddsLocalDevice) {
     registry->addLocalDevice(1, "Test Input", "input", "Manufacturer");
 
-    auto device = registry->getDevice(1);
+    auto device = registry->getLocalDevice(1);
 
     ASSERT_TRUE(device.has_value());
-    EXPECT_EQ(1, device->id);
+    EXPECT_EQ(1, device->id());
     EXPECT_EQ(juce::String("Test Input"), device->name);
     EXPECT_EQ(juce::String("input"), device->type);
-    EXPECT_TRUE(device->isLocal);
+    EXPECT_TRUE(device->isLocal());
     EXPECT_EQ(juce::String("Manufacturer"), device->manufacturer);
 }
 
@@ -48,14 +48,14 @@ TEST_F(DeviceRegistryTest, AddsLocalDevice) {
 TEST_F(DeviceRegistryTest, AddsRemoteDevice) {
     registry->addRemoteDevice(remoteNode1, 2, "Remote Output", "output", "Vendor");
 
-    auto device = registry->getDevice(2);
+    auto device = registry->getDevice(remoteNode1, 2);
 
     ASSERT_TRUE(device.has_value());
-    EXPECT_EQ(2, device->id);
+    EXPECT_EQ(2, device->id());
     EXPECT_EQ(juce::String("Remote Output"), device->name);
     EXPECT_EQ(juce::String("output"), device->type);
-    EXPECT_FALSE(device->isLocal);
-    EXPECT_EQ(remoteNode1, device->ownerNode);
+    EXPECT_FALSE(device->isLocal());
+    EXPECT_EQ(remoteNode1, device->ownerNode());
     EXPECT_EQ(juce::String("Vendor"), device->manufacturer);
 }
 
@@ -65,7 +65,7 @@ TEST_F(DeviceRegistryTest, RemovesLocalDevice) {
 
     registry->removeLocalDevice(1);
 
-    auto device = registry->getDevice(1);
+    auto device = registry->getLocalDevice(1);
     EXPECT_FALSE(device.has_value());
 }
 
@@ -73,9 +73,9 @@ TEST_F(DeviceRegistryTest, RemovesLocalDevice) {
 TEST_F(DeviceRegistryTest, RemovesRemoteDevice) {
     registry->addRemoteDevice(remoteNode1, 2, "Remote Device", "output");
 
-    registry->removeRemoteDevice(2);
+    registry->removeRemoteDevice(remoteNode1, 2);
 
-    auto device = registry->getDevice(2);
+    auto device = registry->getDevice(remoteNode1, 2);
     EXPECT_FALSE(device.has_value());
 }
 
@@ -87,9 +87,9 @@ TEST_F(DeviceRegistryTest, ClearsLocalDevices) {
 
     registry->clearLocalDevices();
 
-    EXPECT_FALSE(registry->getDevice(1).has_value());
-    EXPECT_FALSE(registry->getDevice(2).has_value());
-    EXPECT_TRUE(registry->getDevice(3).has_value());  // Remote should remain
+    EXPECT_FALSE(registry->getLocalDevice(1).has_value());
+    EXPECT_FALSE(registry->getLocalDevice(2).has_value());
+    EXPECT_TRUE(registry->getDevice(remoteNode1, 3).has_value());  // Remote should remain
 }
 
 // Test remove node devices
@@ -100,9 +100,9 @@ TEST_F(DeviceRegistryTest, RemovesNodeDevices) {
 
     registry->removeNodeDevices(remoteNode1);
 
-    EXPECT_FALSE(registry->getDevice(1).has_value());
-    EXPECT_FALSE(registry->getDevice(2).has_value());
-    EXPECT_TRUE(registry->getDevice(3).has_value());  // Different node
+    EXPECT_FALSE(registry->getDevice(remoteNode1, 1).has_value());
+    EXPECT_FALSE(registry->getDevice(remoteNode1, 2).has_value());
+    EXPECT_TRUE(registry->getDevice(remoteNode2, 3).has_value());  // Different node
 }
 
 // Test get all devices
@@ -125,7 +125,7 @@ TEST_F(DeviceRegistryTest, GetsLocalDevices) {
 
     EXPECT_EQ(2u, devices.size());
     for (const auto& device : devices) {
-        EXPECT_TRUE(device.isLocal);
+        EXPECT_TRUE(device.isLocal());
     }
 }
 
@@ -139,7 +139,7 @@ TEST_F(DeviceRegistryTest, GetsRemoteDevices) {
 
     EXPECT_EQ(2u, devices.size());
     for (const auto& device : devices) {
-        EXPECT_FALSE(device.isLocal);
+        EXPECT_FALSE(device.isLocal());
     }
 }
 
@@ -153,13 +153,13 @@ TEST_F(DeviceRegistryTest, GetsNodeDevices) {
 
     EXPECT_EQ(2u, devices.size());
     for (const auto& device : devices) {
-        EXPECT_EQ(remoteNode1, device.ownerNode);
+        EXPECT_EQ(remoteNode1, device.ownerNode());
     }
 }
 
 // Test get non-existent device
 TEST_F(DeviceRegistryTest, GetNonExistentDevice) {
-    auto device = registry->getDevice(999);
+    auto device = registry->getLocalDevice(999);
 
     EXPECT_FALSE(device.has_value());
 }
@@ -224,7 +224,7 @@ TEST_F(DeviceRegistryTest, UpdatesExistingDevice) {
 
     registry->addLocalDevice(1, "Updated Name", "output", "Vendor B");
 
-    auto device = registry->getDevice(1);
+    auto device = registry->getLocalDevice(1);
 
     ASSERT_TRUE(device.has_value());
     EXPECT_EQ(juce::String("Updated Name"), device->name);
@@ -318,11 +318,11 @@ TEST_F(DeviceRegistryTest, HandlesConcurrentReadWrite) {
 
 // Test device equality
 TEST_F(DeviceRegistryTest, DeviceEquality) {
-    MidiDevice device1(1, "Device", "input", true, localNode);
-    MidiDevice device2(1, "Different Name", "output", false, remoteNode1);
-    MidiDevice device3(2, "Device", "input", true, localNode);
+    MidiDevice device1(localNode, 1, "Device", "input");
+    MidiDevice device2(remoteNode1, 1, "Different Name", "output");
+    MidiDevice device3(localNode, 2, "Device", "input");
 
-    EXPECT_TRUE(device1 == device2);  // Same ID
+    EXPECT_FALSE(device1 == device2);  // Different owner node
     EXPECT_FALSE(device1 == device3);  // Different ID
 }
 
@@ -331,8 +331,8 @@ TEST_F(DeviceRegistryTest, StoresDeviceTypes) {
     registry->addLocalDevice(1, "Input Device", "input");
     registry->addLocalDevice(2, "Output Device", "output");
 
-    auto inputDevice = registry->getDevice(1);
-    auto outputDevice = registry->getDevice(2);
+    auto inputDevice = registry->getLocalDevice(1);
+    auto outputDevice = registry->getLocalDevice(2);
 
     ASSERT_TRUE(inputDevice.has_value());
     ASSERT_TRUE(outputDevice.has_value());
@@ -344,7 +344,7 @@ TEST_F(DeviceRegistryTest, StoresDeviceTypes) {
 TEST_F(DeviceRegistryTest, StoresManufacturer) {
     registry->addLocalDevice(1, "Device", "input", "ACME Corp");
 
-    auto device = registry->getDevice(1);
+    auto device = registry->getLocalDevice(1);
 
     ASSERT_TRUE(device.has_value());
     EXPECT_EQ(juce::String("ACME Corp"), device->manufacturer);
@@ -354,7 +354,7 @@ TEST_F(DeviceRegistryTest, StoresManufacturer) {
 TEST_F(DeviceRegistryTest, HandlesEmptyManufacturer) {
     registry->addLocalDevice(1, "Device", "input", "");
 
-    auto device = registry->getDevice(1);
+    auto device = registry->getLocalDevice(1);
 
     ASSERT_TRUE(device.has_value());
     EXPECT_TRUE(device->manufacturer.isEmpty());
diff --git a/modules/juce/midi-server/tests/unit/RoutingTableTest.cpp b/modules/juce/midi-server/tests/unit/RoutingTableTest.cpp
index 5a20044..d6779b7 100644
--- a/modules/juce/midi-server/tests/unit/RoutingTableTest.cpp
+++ b/modules/juce/midi-server/tests/unit/RoutingTableTest.cpp
@@ -32,12 +32,12 @@ protected:
 
 // Test add local route
 TEST_F(RoutingTableTest, AddsLocalRoute) {
-    table->addRoute(1, localNode, "Local Device", "input");
+    table->addRoute(localNode, 1, "Local Device", "input");
 
-    auto route = table->getRoute(1);
+    auto route = table->getLocalRoute(1);
 
     ASSERT_TRUE(route.has_value());
-    EXPECT_EQ(1, route->deviceId);
+    EXPECT_EQ(1, route->deviceId());
     EXPECT_TRUE(route->isLocal());
     EXPECT_EQ(juce::String("Local Device"), route->deviceName);
     EXPECT_EQ(juce::String("input"), route->deviceType);
@@ -45,56 +45,56 @@ TEST_F(RoutingTableTest, AddsLocalRoute) {
 
 // Test add remote route
 TEST_F(RoutingTableTest, AddsRemoteRoute) {
-    table->addRoute(2, remoteNode1, "Remote Device", "output");
+    table->addRoute(remoteNode1, 2, "Remote Device", "output");
 
-    auto route = table->getRoute(2);
+    auto route = table->getRoute(remoteNode1, 2);
 
     ASSERT_TRUE(route.has_value());
-    EXPECT_EQ(2, route->deviceId);
+    EXPECT_EQ(2, route->deviceId());
     EXPECT_FALSE(route->isLocal());
-    EXPECT_EQ(remoteNode1, route->nodeId);
+    EXPECT_EQ(remoteNode1, route->nodeId());
     EXPECT_EQ(juce::String("Remote Device"), route->deviceName);
 }
 
 // Test remove route
 TEST_F(RoutingTableTest, RemovesRoute) {
-    table->addRoute(1, localNode, "Device", "input");
+    table->addRoute(localNode, 1, "Device", "input");
 
-    table->removeRoute(1);
+    table->removeRoute(localNode, 1);
 
-    auto route = table->getRoute(1);
+    auto route = table->getLocalRoute(1);
     EXPECT_FALSE(route.has_value());
 }
 
 // Test remove node routes
 TEST_F(RoutingTableTest, RemovesNodeRoutes) {
-    table->addRoute(1, remoteNode1, "Node1 Device1", "input");
-    table->addRoute(2, remoteNode1, "Node1 Device2", "output");
-    table->addRoute(3, remoteNode2, "Node2 Device", "input");
+    table->addRoute(remoteNode1, 1, "Node1 Device1", "input");
+    table->addRoute(remoteNode1, 2, "Node1 Device2", "output");
+    table->addRoute(remoteNode2, 3, "Node2 Device", "input");
 
     table->removeNodeRoutes(remoteNode1);
 
-    EXPECT_FALSE(table->getRoute(1).has_value());
-    EXPECT_FALSE(table->getRoute(2).has_value());
-    EXPECT_TRUE(table->getRoute(3).has_value());
+    EXPECT_FALSE(table->getRoute(remoteNode1, 1).has_value());
+    EXPECT_FALSE(table->getRoute(remoteNode1, 2).has_value());
+    EXPECT_TRUE(table->getRoute(remoteNode2, 3).has_value());
 }
 
 // Test clear all routes
 TEST_F(RoutingTableTest, ClearsAllRoutes) {
-    table->addRoute(1, localNode, "Local", "input");
-    table->addRoute(2, remoteNode1, "Remote", "output");
+    table->addRoute(localNode, 1, "Local", "input");
+    table->addRoute(remoteNode1, 2, "Remote", "output");
 
     table->clearAllRoutes();
 
-    EXPECT_FALSE(table->getRoute(1).has_value());
-    EXPECT_FALSE(table->getRoute(2).has_value());
+    EXPECT_FALSE(table->getLocalRoute(1).has_value());
+    EXPECT_FALSE(table->getRoute(remoteNode1, 2).has_value());
     EXPECT_EQ(0, table->getTotalRouteCount());
 }
 
 // Test get all routes
 TEST_F(RoutingTableTest, GetsAllRoutes) {
-    table->addRoute(1, localNode, "Local", "input");
-    table->addRoute(2, remoteNode1, "Remote", "output");
+    table->addRoute(localNode, 1, "Local", "input");
+    table->addRoute(remoteNode1, 2, "Remote", "output");
 
     auto routes = table->getAllRoutes();
 
@@ -103,9 +103,9 @@ TEST_F(RoutingTableTest, GetsAllRoutes) {
 
 // Test get local routes
 TEST_F(RoutingTableTest, GetsLocalRoutes) {
-    table->addRoute(1, localNode, "Local 1", "input");
-    table->addRoute(2, localNode, "Local 2", "output");
-    table->addRoute(3, remoteNode1, "Remote", "input");
+    table->addRoute(localNode, 1, "Local 1", "input");
+    table->addRoute(localNode, 2, "Local 2", "output");
+    table->addRoute(remoteNode1, 3, "Remote", "input");
 
     auto routes = table->getLocalRoutes();
 
@@ -117,9 +117,9 @@ TEST_F(RoutingTableTest, GetsLocalRoutes) {
 
 // Test get remote routes
 TEST_F(RoutingTableTest, GetsRemoteRoutes) {
-    table->addRoute(1, localNode, "Local", "input");
-    table->addRoute(2, remoteNode1, "Remote 1", "output");
-    table->addRoute(3, remoteNode2, "Remote 2", "input");
+    table->addRoute(localNode, 1, "Local", "input");
+    table->addRoute(remoteNode1, 2, "Remote 1", "output");
+    table->addRoute(remoteNode2, 3, "Remote 2", "input");
 
     auto routes = table->getRemoteRoutes();
 
@@ -131,77 +131,77 @@ TEST_F(RoutingTableTest, GetsRemoteRoutes) {
 
 // Test get node routes
 TEST_F(RoutingTableTest, GetsNodeRoutes) {
-    table->addRoute(1, remoteNode1, "Node1 Device1", "input");
-    table->addRoute(2, remoteNode1, "Node1 Device2", "output");
-    table->addRoute(3, remoteNode2, "Node2 Device", "input");
+    table->addRoute(remoteNode1, 1, "Node1 Device1", "input");
+    table->addRoute(remoteNode1, 2, "Node1 Device2", "output");
+    table->addRoute(remoteNode2, 3, "Node2 Device", "input");
 
     auto routes = table->getNodeRoutes(remoteNode1);
 
     EXPECT_EQ(2u, routes.size());
     for (const auto& route : routes) {
-        EXPECT_EQ(remoteNode1, route.nodeId);
+        EXPECT_EQ(remoteNode1, route.nodeId());
     }
 }
 
 // Test has route
 TEST_F(RoutingTableTest, ChecksRouteExists) {
-    table->addRoute(1, localNode, "Device", "input");
+    table->addRoute(localNode, 1, "Device", "input");
 
-    EXPECT_TRUE(table->hasRoute(1));
-    EXPECT_FALSE(table->hasRoute(999));
+    EXPECT_TRUE(table->hasLocalRoute(1));
+    EXPECT_FALSE(table->hasLocalRoute(999));
 }
 
 // Test is local device
 TEST_F(RoutingTableTest, ChecksIsLocalDevice) {
-    table->addRoute(1, localNode, "Local", "input");
-    table->addRoute(2, remoteNode1, "Remote", "output");
+    table->addRoute(localNode, 1, "Local", "input");
+    table->addRoute(remoteNode1, 2, "Remote", "output");
 
-    EXPECT_TRUE(table->isLocalDevice(1));
-    EXPECT_FALSE(table->isLocalDevice(2));
-    EXPECT_FALSE(table->isLocalDevice(999));  // Non-existent
+    EXPECT_TRUE(table->isLocalDevice(localNode, 1));
+    EXPECT_FALSE(table->isLocalDevice(remoteNode1, 2));
+    EXPECT_FALSE(table->isLocalDevice(localNode, 999));  // Non-existent
 }
 
 // Test is remote device
 TEST_F(RoutingTableTest, ChecksIsRemoteDevice) {
-    table->addRoute(1, localNode, "Local", "input");
-    table->addRoute(2, remoteNode1, "Remote", "output");
+    table->addRoute(localNode, 1, "Local", "input");
+    table->addRoute(remoteNode1, 2, "Remote", "output");
 
-    EXPECT_FALSE(table->isRemoteDevice(1));
-    EXPECT_TRUE(table->isRemoteDevice(2));
-    EXPECT_FALSE(table->isRemoteDevice(999));  // Non-existent
+    EXPECT_FALSE(table->isRemoteDevice(localNode, 1));
+    EXPECT_TRUE(table->isRemoteDevice(remoteNode1, 2));
+    EXPECT_FALSE(table->isRemoteDevice(localNode, 999));  // Non-existent
 }
 
 // Test total route count
 TEST_F(RoutingTableTest, GetsTotalRouteCount) {
-    table->addRoute(1, localNode, "Local", "input");
-    table->addRoute(2, remoteNode1, "Remote", "output");
+    table->addRoute(localNode, 1, "Local", "input");
+    table->addRoute(remoteNode1, 2, "Remote", "output");
 
     EXPECT_EQ(2, table->getTotalRouteCount());
 }
 
 // Test local route count
 TEST_F(RoutingTableTest, GetsLocalRouteCount) {
-    table->addRoute(1, localNode, "Local 1", "input");
-    table->addRoute(2, localNode, "Local 2", "output");
-    table->addRoute(3, remoteNode1, "Remote", "input");
+    table->addRoute(localNode, 1, "Local 1", "input");
+    table->addRoute(localNode, 2, "Local 2", "output");
+    table->addRoute(remoteNode1, 3, "Remote", "input");
 
     EXPECT_EQ(2, table->getLocalRouteCount());
 }
 
 // Test remote route count
 TEST_F(RoutingTableTest, GetsRemoteRouteCount) {
-    table->addRoute(1, localNode, "Local", "input");
-    table->addRoute(2, remoteNode1, "Remote 1", "output");
-    table->addRoute(3, remoteNode2, "Remote 2", "input");
+    table->addRoute(localNode, 1, "Local", "input");
+    table->addRoute(remoteNode1, 2, "Remote 1", "output");
+    table->addRoute(remoteNode2, 3, "Remote 2", "input");
 
     EXPECT_EQ(2, table->getRemoteRouteCount());
 }
 
 // Test node route count
 TEST_F(RoutingTableTest, GetsNodeRouteCount) {
-    table->addRoute(1, remoteNode1, "Node1 Device1", "input");
-    table->addRoute(2, remoteNode1, "Node1 Device2", "output");
-    table->addRoute(3, remoteNode2, "Node2 Device", "input");
+    table->addRoute(remoteNode1, 1, "Node1 Device1", "input");
+    table->addRoute(remoteNode1, 2, "Node1 Device2", "output");
+    table->addRoute(remoteNode2, 3, "Node2 Device", "input");
 
     EXPECT_EQ(2, table->getNodeRouteCount(remoteNode1));
     EXPECT_EQ(1, table->getNodeRouteCount(remoteNode2));
@@ -210,49 +210,49 @@ TEST_F(RoutingTableTest, GetsNodeRouteCount) {
 // Test add routes bulk
 TEST_F(RoutingTableTest, AddsBulkRoutes) {
     std::vector<Route> routes;
-    routes.push_back(Route(1, localNode, "Device 1", "input"));
-    routes.push_back(Route(2, remoteNode1, "Device 2", "output"));
-    routes.push_back(Route(3, remoteNode1, "Device 3", "input"));
+    routes.push_back(Route(localNode, 1, "Device 1", "input"));
+    routes.push_back(Route(remoteNode1, 2, "Device 2", "output"));
+    routes.push_back(Route(remoteNode1, 3, "Device 3", "input"));
 
     table->addRoutes(routes);
 
     EXPECT_EQ(3, table->getTotalRouteCount());
-    EXPECT_TRUE(table->hasRoute(1));
-    EXPECT_TRUE(table->hasRoute(2));
-    EXPECT_TRUE(table->hasRoute(3));
+    EXPECT_TRUE(table->hasLocalRoute(1));
+    EXPECT_TRUE(table->hasRoute(remoteNode1, 2));
+    EXPECT_TRUE(table->hasRoute(remoteNode1, 3));
 }
 
 // Test replace node routes
 TEST_F(RoutingTableTest, ReplacesNodeRoutes) {
-    table->addRoute(1, remoteNode1, "Old Device 1", "input");
-    table->addRoute(2, remoteNode1, "Old Device 2", "output");
+    table->addRoute(remoteNode1, 1, "Old Device 1", "input");
+    table->addRoute(remoteNode1, 2, "Old Device 2", "output");
 
     std::vector<Route> newRoutes;
-    newRoutes.push_back(Route(3, remoteNode1, "New Device 1", "input"));
-    newRoutes.push_back(Route(4, remoteNode1, "New Device 2", "output"));
+    newRoutes.push_back(Route(remoteNode1, 3, "New Device 1", "input"));
+    newRoutes.push_back(Route(remoteNode1, 4, "New Device 2", "output"));
 
     table->replaceNodeRoutes(remoteNode1, newRoutes);
 
-    EXPECT_FALSE(table->hasRoute(1));
-    EXPECT_FALSE(table->hasRoute(2));
-    EXPECT_TRUE(table->hasRoute(3));
-    EXPECT_TRUE(table->hasRoute(4));
+    EXPECT_FALSE(table->hasRoute(remoteNode1, 1));
+    EXPECT_FALSE(table->hasRoute(remoteNode1, 2));
+    EXPECT_TRUE(table->hasRoute(remoteNode1, 3));
+    EXPECT_TRUE(table->hasRoute(remoteNode1, 4));
     EXPECT_EQ(2, table->getNodeRouteCount(remoteNode1));
 }
 
 // Test update existing route
 TEST_F(RoutingTableTest, UpdatesExistingRoute) {
-    table->addRoute(1, localNode, "Original Name", "input");
+    table->addRoute(localNode, 1, "Original Name", "input");
 
-    table->addRoute(1, remoteNode1, "Updated Name", "output");
+    table->addRoute(localNode, 1, "Updated Name", "output");
 
-    auto route = table->getRoute(1);
+    auto route = table->getLocalRoute(1);
 
     ASSERT_TRUE(route.has_value());
     EXPECT_EQ(juce::String("Updated Name"), route->deviceName);
     EXPECT_EQ(juce::String("output"), route->deviceType);
-    EXPECT_FALSE(route->isLocal());
-    EXPECT_EQ(remoteNode1, route->nodeId);
+    EXPECT_TRUE(route->isLocal());
+    EXPECT_EQ(localNode, route->nodeId());
 }
 
 // Test empty table
@@ -267,18 +267,18 @@ TEST_F(RoutingTableTest, EmptyTable) {
 
 // Test route equality
 TEST_F(RoutingTableTest, RouteEquality) {
-    Route route1(1, localNode, "Device", "input");
-    Route route2(1, remoteNode1, "Different", "output");
-    Route route3(2, localNode, "Device", "input");
+    Route route1(localNode, 1, "Device", "input");
+    Route route2(remoteNode1, 1, "Different", "output");
+    Route route3(localNode, 2, "Device", "input");
 
-    EXPECT_TRUE(route1 == route2);  // Same device ID
+    EXPECT_FALSE(route1 == route2);  // Different node ID
     EXPECT_FALSE(route1 == route3);  // Different device ID
 }
 
 // Test route isLocal
 TEST_F(RoutingTableTest, RouteIsLocal) {
-    Route localRoute(1, juce::Uuid::null(), "Local", "input");
-    Route remoteRoute(2, remoteNode1, "Remote", "output");
+    Route localRoute(juce::Uuid::null(), 1, "Local", "input");
+    Route remoteRoute(remoteNode1, 2, "Remote", "output");
 
     EXPECT_TRUE(localRoute.isLocal());
     EXPECT_FALSE(remoteRoute.isLocal());
@@ -290,7 +290,7 @@ TEST_F(RoutingTableTest, HandlesConcurrentAddition) {
 
     for (int i = 0; i < 10; ++i) {
         threads.emplace_back([this, i]() {
-            table->addRoute(i, remoteNode1, "Device " + juce::String(i), "input");
+            table->addRoute(remoteNode1, i, "Device " + juce::String(i), "input");
         });
     }
 
@@ -305,7 +305,7 @@ TEST_F(RoutingTableTest, HandlesConcurrentAddition) {
 TEST_F(RoutingTableTest, HandlesConcurrentRemoval) {
     // Add routes
     for (int i = 0; i < 10; ++i) {
-        table->addRoute(i, remoteNode1, "Device " + juce::String(i), "input");
+        table->addRoute(remoteNode1, i, "Device " + juce::String(i), "input");
     }
 
     // Remove concurrently
@@ -313,7 +313,7 @@ TEST_F(RoutingTableTest, HandlesConcurrentRemoval) {
 
     for (int i = 0; i < 10; ++i) {
         threads.emplace_back([this, i]() {
-            table->removeRoute(i);
+            table->removeRoute(remoteNode1, i);
         });
     }
 
@@ -333,7 +333,7 @@ TEST_F(RoutingTableTest, HandlesConcurrentReadWrite) {
     threads.emplace_back([this, &running]() {
         uint16_t id = 0;
         while (running) {
-            table->addRoute(id++, remoteNode1, "Device", "input");
+            table->addRoute(remoteNode1, id++, "Device", "input");
             std::this_thread::sleep_for(std::chrono::milliseconds(1));
         }
     });
@@ -360,7 +360,7 @@ TEST_F(RoutingTableTest, HandlesConcurrentReadWrite) {
 
 // Test get non-existent route
 TEST_F(RoutingTableTest, GetNonExistentRoute) {
-    auto route = table->getRoute(999);
+    auto route = table->getLocalRoute(999);
 
     EXPECT_FALSE(route.has_value());
 }
@@ -376,8 +376,8 @@ TEST_F(RoutingTableTest, HandlesEmptyBulkAdd) {
 
 // Test replace with empty routes
 TEST_F(RoutingTableTest, ReplacesWithEmptyRoutes) {
-    table->addRoute(1, remoteNode1, "Device 1", "input");
-    table->addRoute(2, remoteNode1, "Device 2", "output");
+    table->addRoute(remoteNode1, 1, "Device 1", "input");
+    table->addRoute(remoteNode1, 2, "Device 2", "output");
 
     std::vector<Route> emptyRoutes;
     table->replaceNodeRoutes(remoteNode1, emptyRoutes);
@@ -387,19 +387,19 @@ TEST_F(RoutingTableTest, ReplacesWithEmptyRoutes) {
 
 // Test local node identification
 TEST_F(RoutingTableTest, IdentifiesLocalNode) {
-    Route route(1, juce::Uuid::null(), "Device", "input");
+    Route route(juce::Uuid::null(), 1, "Device", "input");
 
-    EXPECT_TRUE(route.nodeId.isNull());
+    EXPECT_TRUE(route.nodeId().isNull());
     EXPECT_TRUE(route.isLocal());
 }
 
 // Test device type preservation
 TEST_F(RoutingTableTest, PreservesDeviceType) {
-    table->addRoute(1, localNode, "Input Device", "input");
-    table->addRoute(2, localNode, "Output Device", "output");
+    table->addRoute(localNode, 1, "Input Device", "input");
+    table->addRoute(localNode, 2, "Output Device", "output");
 
-    auto inputRoute = table->getRoute(1);
-    auto outputRoute = table->getRoute(2);
+    auto inputRoute = table->getLocalRoute(1);
+    auto outputRoute = table->getLocalRoute(2);
 
     ASSERT_TRUE(inputRoute.has_value());
     ASSERT_TRUE(outputRoute.has_value());
@@ -418,8 +418,8 @@ TEST_F(RoutingTableTest, GetsEmptyNodeRoutes) {
 
 // Test mixed local and remote routes
 TEST_F(RoutingTableTest, HandlesMixedRoutes) {
-    table->addRoute(1, localNode, "Local", "input");
-    table->addRoute(2, remoteNode1, "Remote", "output");
+    table->addRoute(localNode, 1, "Local", "input");
+    table->addRoute(remoteNode1, 2, "Remote", "output");
 
     EXPECT_EQ(2, table->getTotalRouteCount());
     EXPECT_EQ(1, table->getLocalRouteCount());


---

_**Agent (claude-sonnet-4-5-20250929)**_

refactor(midi-server): migrate MidiDevice and Route to Phase 1 composite key accessors

