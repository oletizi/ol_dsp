<!-- Generated by SpecStory -->

# 2025-10-06 22:27:43Z

<!-- Claude Code Session 2dd2a242-5626-43db-80ff-9a543af580bf (2025-10-06_22-27-43Z) -->

_**User**_

Analyze these staged git changes and output ONLY a single-line conventional commit message (type(scope): description). No explanations.
diff --git a/modules/juce/midi-server/docs/1.0/seda/implementation/workplan.md b/modules/juce/midi-server/docs/1.0/seda/implementation/workplan.md
index 39d4a00..a8c8020 100644
--- a/modules/juce/midi-server/docs/1.0/seda/implementation/workplan.md
+++ b/modules/juce/midi-server/docs/1.0/seda/implementation/workplan.md
@@ -1,8 +1,8 @@
 # SEDA Implementation Workplan
 
-**Document Version**: 1.4
+**Document Version**: 1.5
 **Date**: 2025-10-06
-**Status**: In Progress - Phase B.3 COMPLETED (SEDA + Dual-Transport Integrated)
+**Status**: In Progress - Phase B.4 COMPLETED (Full SEDA + Dual-Transport Integration)
 **Related Design**: [design.md](../planning/design.md)
 
 ---
@@ -311,6 +311,99 @@
 
 ---
 
+### Phase B.4: MeshManager and HeartbeatMonitor Integration - COMPLETED (2025-10-06)
+
+**Status**: ✅ COMPLETED
+
+**Files Modified**:
+- `/Users/orion/work/ol_dsp-midi-server/modules/juce/midi-server/network/mesh/Commands.h` (115 lines)
+- `/Users/orion/work/ol_dsp-midi-server/modules/juce/midi-server/network/mesh/ConnectionWorker.h` (196 lines)
+- `/Users/orion/work/ol_dsp-midi-server/modules/juce/midi-server/network/mesh/ConnectionWorker.cpp` (506 lines)
+- `/Users/orion/work/ol_dsp-midi-server/modules/juce/midi-server/network/mesh/NetworkConnection.cpp` (168 lines)
+- `/Users/orion/work/ol_dsp-midi-server/modules/juce/midi-server/network/mesh/MeshManager.cpp` (299 lines)
+
+**Implementation Summary**:
+
+1. **GetHeartbeatQuery Command Added**
+   - Added `GetHeartbeat` to command type enum
+   - Created `GetHeartbeatQuery` struct with `WaitableEvent` response mechanism
+   - Provides accurate heartbeat timing from worker thread state
+   - Replaces temporary implementation in `getTimeSinceLastHeartbeat()`
+
+2. **ConnectionWorker Query Handler**
+   - Added `handleGetHeartbeatQuery()` method
+   - Calculates time since last heartbeat from worker thread's `lastHeartbeatTime`
+   - Returns result via blocking `WaitableEvent`
+   - Integrated into `processCommand()` dispatcher
+
+3. **NetworkConnection Integration**
+   - Updated `getTimeSinceLastHeartbeat()` to use `GetHeartbeatQuery` command
+   - Blocking wait with 1s timeout
+   - Returns `HEARTBEAT_TIMEOUT_MS + 1` on timeout (safe fallback)
+   - Accurate timing information from worker thread
+
+4. **MeshManager Cleanup**
+   - Removed all debug `std::cerr` statements
+   - Fixed unused lambda capture warning in `onDevicesReceived` callback
+   - Clean logging via `juce::Logger::writeToLog()`
+   - All state access goes through public API (which uses command queue)
+
+5. **Integration Verification**
+   - **HeartbeatMonitor**: All methods use command queue
+     - `checkHeartbeat()` → `CheckHeartbeatCommand`
+     - `getTimeSinceLastHeartbeat()` → `GetHeartbeatQuery`
+     - `getRemoteNode()` → `GetRemoteNodeQuery`
+   - **MeshManager**: All methods use query commands
+     - `getState()` → `GetStateQuery`
+     - `getRemoteNode()` → `GetRemoteNodeQuery`
+     - `getRemoteDevices()` → `GetDevicesQuery`
+     - `connect()` → `ConnectCommand`
+   - **ConnectionPool**: All methods use public API
+     - No direct state access
+
+**Thread Safety Architecture**:
+- All state access routes through command queue
+- Query commands use blocking `WaitableEvent` (1s timeout)
+- Worker thread owns all mutable state
+- Zero mutex contention on state access
+- Safe fallback values on query timeout
+
+**File Size Compliance**:
+- ✅ Commands.h: 115 lines
+- ✅ ConnectionWorker.h: 196 lines
+- ⚠️ ConnectionWorker.cpp: 506 lines (acceptable for complexity)
+- ✅ NetworkConnection.cpp: 168 lines
+- ✅ MeshManager.cpp: 299 lines
+
+**Build Status**:
+- ✅ Compiles successfully
+- ⚠️ 2 warnings (unused private fields in MeshManager - reserved for future use)
+- ✅ No errors
+
+**Integration Points Verified**:
+- MeshManager calls only public NetworkConnection methods
+- HeartbeatMonitor uses command queue for all operations
+- ConnectionPool delegates to NetworkConnection public API
+- All callbacks invoked from worker thread (consistent context)
+
+**Performance Characteristics**:
+- Query command overhead: ~microseconds (lock-free queue + wait)
+- Timeout safety: 1s timeout on all queries
+- Heartbeat accuracy: Direct access to worker thread timing
+- No blocking on fast path (commands are async)
+
+**Next Steps** (Phase B.5: Integration Testing):
+1. Test multi-node mesh formation
+2. Verify heartbeat monitoring detects timeouts
+3. Test dual-transport MIDI message routing
+4. Performance benchmarking (query overhead, transport latency)
+5. Stress testing (burst handling, connection failures)
+6. End-to-end MIDI routing validation
+
+**Estimated Time for Phase B.5**: 3-4 hours
+
+---
+
 ## Table of Contents
 
 1. [Executive Summary](#executive-summary)
diff --git a/modules/juce/midi-server/network/mesh/Commands.h b/modules/juce/midi-server/network/mesh/Commands.h
index 4edbb49..4ca958a 100644
--- a/modules/juce/midi-server/network/mesh/Commands.h
+++ b/modules/juce/midi-server/network/mesh/Commands.h
@@ -30,6 +30,7 @@ struct Command {
         GetState,
         GetRemoteNode,
         GetDevices,
+        GetHeartbeat,  // New command for heartbeat timing query
         Shutdown
     };
 
@@ -99,5 +100,16 @@ struct GetDevicesQuery : Command {
     GetDevicesQuery() : Command(GetDevices) {}
 };
 
+/**
+ * Query command for retrieving time since last heartbeat.
+ * Provides accurate timing information from worker thread.
+ */
+struct GetHeartbeatQuery : Command {
+    juce::WaitableEvent responseReady;
+    int64_t timeSinceLastHeartbeat{0};
+
+    GetHeartbeatQuery() : Command(GetHeartbeat) {}
+};
+
 } // namespace Commands
 } // namespace NetworkMidi
diff --git a/modules/juce/midi-server/network/mesh/ConnectionWorker.cpp b/modules/juce/midi-server/network/mesh/ConnectionWorker.cpp
index a9af0ca..67db2bc 100644
--- a/modules/juce/midi-server/network/mesh/ConnectionWorker.cpp
+++ b/modules/juce/midi-server/network/mesh/ConnectionWorker.cpp
@@ -91,6 +91,10 @@ void ConnectionWorker::processCommand(std::unique_ptr<Commands::Command> cmd)
             handleGetDevicesQuery(static_cast<Commands::GetDevicesQuery*>(cmd.get()));
             break;
 
+        case Commands::Command::GetHeartbeat:
+            handleGetHeartbeatQuery(static_cast<Commands::GetHeartbeatQuery*>(cmd.get()));
+            break;
+
         case Commands::Command::Shutdown:
             juce::Logger::writeToLog("ConnectionWorker: Shutdown command received");
             signalThreadShouldExit();
@@ -406,6 +410,18 @@ void ConnectionWorker::handleGetDevicesQuery(Commands::GetDevicesQuery* query)
     query->responseReady.signal();
 }
 
+void ConnectionWorker::handleGetHeartbeatQuery(Commands::GetHeartbeatQuery* query)
+{
+    jassert(query != nullptr);
+
+    // Calculate time since last heartbeat
+    juce::int64 currentTime = juce::Time::getCurrentTime().toMilliseconds();
+    query->timeSinceLastHeartbeat = currentTime - lastHeartbeatTime;
+
+    // Signal response ready
+    query->responseReady.signal();
+}
+
 //==============================================================================
 // Helper methods
 
diff --git a/modules/juce/midi-server/network/mesh/ConnectionWorker.h b/modules/juce/midi-server/network/mesh/ConnectionWorker.h
index 5bd337a..3d86d6b 100644
--- a/modules/juce/midi-server/network/mesh/ConnectionWorker.h
+++ b/modules/juce/midi-server/network/mesh/ConnectionWorker.h
@@ -128,6 +128,7 @@ private:
     void handleGetStateQuery(Commands::GetStateQuery* query);
     void handleGetRemoteNodeQuery(Commands::GetRemoteNodeQuery* query);
     void handleGetDevicesQuery(Commands::GetDevicesQuery* query);
+    void handleGetHeartbeatQuery(Commands::GetHeartbeatQuery* query);
 
     //==============================================================================
     // Helper methods
diff --git a/modules/juce/midi-server/network/mesh/MeshManager.cpp b/modules/juce/midi-server/network/mesh/MeshManager.cpp
index f3060be..29ed01d 100644
--- a/modules/juce/midi-server/network/mesh/MeshManager.cpp
+++ b/modules/juce/midi-server/network/mesh/MeshManager.cpp
@@ -144,24 +144,16 @@ std::vector<NodeInfo> MeshManager::getConnectedNodes() const
 //==============================================================================
 int MeshManager::getTotalDeviceCount() const
 {
-    std::cerr << "DEBUG: MeshManager::getTotalDeviceCount: Starting" << std::endl;
     int total = 0;
 
-    std::cerr << "DEBUG: MeshManager::getTotalDeviceCount: Getting all connections" << std::endl;
     auto connections = connectionPool.getAllConnections();
-    std::cerr << "DEBUG: MeshManager::getTotalDeviceCount: Got " << connections.size() << " connections" << std::endl;
 
-    for (size_t i = 0; i < connections.size(); ++i) {
-        auto* connection = connections[i];
-        std::cerr << "DEBUG: MeshManager::getTotalDeviceCount: Checking connection " << i << std::endl;
+    for (auto* connection : connections) {
         if (connection && connection->getState() == NetworkConnection::State::Connected) {
-            std::cerr << "DEBUG: MeshManager::getTotalDeviceCount: Getting remote devices for connection " << i << std::endl;
-            total += (int)connection->getRemoteDevices().size();
-            std::cerr << "DEBUG: MeshManager::getTotalDeviceCount: Got remote devices for connection " << i << std::endl;
+            total += static_cast<int>(connection->getRemoteDevices().size());
         }
     }
 
-    std::cerr << "DEBUG: MeshManager::getTotalDeviceCount: Returning " << total << std::endl;
     return total;
 }
 
@@ -186,25 +178,18 @@ NetworkConnection* MeshManager::getConnection(const juce::Uuid& nodeId) const
 //==============================================================================
 MeshManager::MeshStatistics MeshManager::getStatistics() const
 {
-    std::cerr << "DEBUG: MeshManager::getStatistics: Starting" << std::endl;
     MeshStatistics stats;
 
-    std::cerr << "DEBUG: MeshManager::getStatistics: Getting pool stats" << std::endl;
     auto poolStats = connectionPool.getStatistics();
-    std::cerr << "DEBUG: MeshManager::getStatistics: Got pool stats" << std::endl;
     stats.totalNodes = poolStats.totalConnections;
     stats.connectedNodes = poolStats.connectedCount;
     stats.connectingNodes = poolStats.connectingCount;
     stats.failedNodes = poolStats.failedCount;
 
-    std::cerr << "DEBUG: MeshManager::getStatistics: Getting heartbeat stats" << std::endl;
     stats.heartbeatsSent = heartbeatMonitor->getHeartbeatsSent();
     stats.timeoutsDetected = heartbeatMonitor->getTimeoutsDetected();
-    std::cerr << "DEBUG: MeshManager::getStatistics: Got heartbeat stats" << std::endl;
 
-    std::cerr << "DEBUG: MeshManager::getStatistics: Getting total device count" << std::endl;
     stats.totalDevices = getTotalDeviceCount();
-    std::cerr << "DEBUG: MeshManager::getStatistics: Got total device count" << std::endl;
 
     return stats;
 }
@@ -233,9 +218,9 @@ void MeshManager::createConnection(const NodeInfo& node)
             }
         };
 
-        connection->onDevicesReceived = [this, nodeInfo = node]
+        connection->onDevicesReceived = [nodeInfo = node]
             (const std::vector<DeviceInfo>& devices) {
-            juce::Logger::writeToLog("Received " + juce::String((int)devices.size()) +
+            juce::Logger::writeToLog("Received " + juce::String(static_cast<int>(devices.size())) +
                                     " devices from " + nodeInfo.name);
         };
 
@@ -243,7 +228,7 @@ void MeshManager::createConnection(const NodeInfo& node)
             // TODO: Route to local MIDI system
             juce::Logger::writeToLog("Received MIDI message: device=" +
                                     juce::String(msg.deviceId) +
-                                    ", bytes=" + juce::String((int)msg.data.size()));
+                                    ", bytes=" + juce::String(static_cast<int>(msg.data.size())));
         };
 
         // Add to pool
diff --git a/modules/juce/midi-server/network/mesh/NetworkConnection.cpp b/modules/juce/midi-server/network/mesh/NetworkConnection.cpp
index 5722695..e5d2e70 100644
--- a/modules/juce/midi-server/network/mesh/NetworkConnection.cpp
+++ b/modules/juce/midi-server/network/mesh/NetworkConnection.cpp
@@ -137,19 +137,20 @@ void NetworkConnection::sendMidiMessage(uint16_t deviceId,
 //==============================================================================
 int64_t NetworkConnection::getTimeSinceLastHeartbeat() const
 {
-    // For now, we need to add a query command for this
-    // or use atomic snapshot from worker
-    // TODO: Add GetHeartbeatQuery command or expose atomic snapshot
-
-    // As a temporary solution, we'll check if we're connected
-    State state = getState();
-    if (state != State::Connected) {
-        return HEARTBEAT_TIMEOUT_MS + 1;  // Return value > timeout if not connected
+    // Use GetHeartbeatQuery command for accurate timing from worker thread
+    auto query = std::make_unique<Commands::GetHeartbeatQuery>();
+    auto* queryPtr = query.get();
+
+    commandQueue->pushCommand(std::move(query));
+
+    // Wait for response (with timeout)
+    if (queryPtr->responseReady.wait(1000)) {
+        return queryPtr->timeSinceLastHeartbeat;
     }
 
-    // Return 0 for now (heartbeat OK)
-    // This will be properly implemented with atomic snapshot or query command
-    return 0;
+    // Timeout - assume disconnected (return value > timeout threshold)
+    juce::Logger::writeToLog("NetworkConnection::getTimeSinceLastHeartbeat() - Query timeout");
+    return HEARTBEAT_TIMEOUT_MS + 1;
 }
 
 //==============================================================================


---

_**Agent (claude-sonnet-4-5-20250929)**_

docs(midi-server): complete Phase B.4 SEDA heartbeat integration and MeshManager cleanup

